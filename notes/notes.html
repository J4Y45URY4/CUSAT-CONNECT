<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyNotes - Student Notes Portal</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 0;
            color: #1d1d1f;
        }

        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.5s;
        }

        .welcome-logo {
            font-size: 48px;
            font-weight: 600;
        }

        .welcome-message {
            font-size: 18px;
            margin: 20px 0;
            text-align: center;
            max-width: 400px;
        }

        .welcome-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .welcome-button:hover {
            background-color: #005bb5;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
        }

        .search-bar {
            padding: 8px 15px;
            width: 300px;
            border: none;
            background-color: #e8e8ed;
            border-radius: 20px;
            font-size: 16px;
        }

        .main-container {
            padding: 20px;
            text-align: center;
        }

        .title {
            font-size: 32px;
            font-weight: 600;
            margin: 0;
        }

        .subtitle {
            font-size: 16px;
            color: #6e6e73;
            margin: 10px 0;
        }

        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .department-card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .department-card:hover {
            background: #f0f0f0;
        }

        .department-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            border-radius: 50%;
        }

        .department-info {
            margin-top: 10px;
        }

        .department-name {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .department-desc {
            font-size: 14px;
            color: #6e6e73;
            margin: 5px 0 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .close-button {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #6e6e73;
        }

        .close-button:hover {
            color: #1d1d1f;
        }

        .breadcrumb {
            margin-bottom: 10px;
            font-size: 14px;
            color: #6e6e73;
        }

        .breadcrumb-item {
            display: inline-block;
            margin-right: 5px;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: #007aff;
        }

        .breadcrumb-item::after {
            content: ' >';
        }

        .breadcrumb-item:last-child::after {
            content: '';
        }

        .semester-list, .subject-list, .notes-list {
            margin-top: 10px;
        }

        .semester-item, .subject-item, .notes-item {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .semester-item:hover, .subject-item:hover {
            background: #f0f0f0;
        }

        .notes-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: default;
        }

        .notes-name {
            font-weight: 500;
        }

        .notes-badge {
            background: #007aff;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }

        .notes-date {
            font-size: 12px;
            color: #6e6e73;
        }

        .download-button {
            padding: 5px 10px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .download-button:hover {
            background: #005bb5;
        }

        .back-button {
            margin: 10px 0;
            padding: 5px 10px;
            background: #e8e8ed;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: #1d1d1f;
        }

        .back-button:hover {
            background: #d0d0d5;
        }

        .error-message {
            color: #ff3b30;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Welcome Overlay -->
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-logo">StudyNotes</div>
        <p class="welcome-message">Your one-stop destination for all academic notes, organized by departments and semesters.</p>
        <button class="welcome-button" id="enterButton">Enter</button>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="logo">StudyNotes</div>
        <input type="text" class="search-bar" id="searchBar" placeholder="Search for notes...">
    </header>
    
    <!-- Main Content -->
    <div class="main-container">
        <h1 class="title">Student Notes Portal</h1>
        <p class="subtitle">Select your department to access course materials and lecture notes</p>
        <div class="departments-grid" id="departmentsGrid"></div>
    </div>
    
    <!-- Department Modal -->
    <div class="modal" id="departmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Department</h2>
                <button class="close-button" id="closeModal">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Airtable Configuration
        const AIRTABLE_PAT = 'pate5r7JSDV1BfXJR.cbe81f76c73b71ce8b399b2d71426cb7e0f89df7fefc4b8f9e2c97190381e191';
        const AIRTABLE_BASE_ID = 'appAN1TbPo89WT3mA';
        const BASE_URL = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}`;

        // DOM Elements
        const welcomeOverlay = document.getElementById('welcomeOverlay');
        const enterButton = document.getElementById('enterButton');
        const departmentsGrid = document.getElementById('departmentsGrid');
        const departmentModal = document.getElementById('departmentModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModal = document.getElementById('closeModal');
        const searchBar = document.getElementById('searchBar');

        // Navigation State
        let currentDept = null;
        let currentSem = null;
        let currentSubject = null;
        let breadcrumbHistory = [];
        let departmentsData = {};
        const cache = {};

        // Fetch Data from Airtable
        async function fetchFromAirtable(table, filter = '', offset = null) {
            let url = `${BASE_URL}/${table}${filter ? `?filterByFormula=${filter}` : ''}`;
            if (offset) url += `&offset=${offset}`;
            const response = await axios.get(url, {
                headers: { Authorization: `Bearer ${AIRTABLE_PAT}` }
            });
            const data = response.data;
            return { records: data.records, offset: data.offset };
        }

        // Fetch Departments
        async function fetchDepartments() {
            if (cache['Departments']) return cache['Departments'];
            const { records } = await fetchFromAirtable('Departments');
            departmentsData = records.reduce((acc, record) => {
                acc[record.id] = {
                    id: record.id,
                    name: record.fields.Name || 'Unnamed Department',
                    description: record.fields.Description || 'No description',
                    icon: record.fields.Icon || '📚',
                    color: record.fields.Color || '#007aff'
                };
                return acc;
            }, {});
            cache['Departments'] = departmentsData;
            renderDepartments();
        }

        // Fetch Semesters
        async function fetchSemesters(deptId) {
            const cacheKey = `Semesters_${deptId}`;
            if (cache[cacheKey]) return cache[cacheKey];
            const { records } = await fetchFromAirtable('Semesters', `{Department}="${deptId}"`);
            const semesters = records.map(record => ({
                id: record.id,
                name: record.fields.Name || 'Unnamed Semester'
            }));
            cache[cacheKey] = semesters;
            return semesters;
        }

        // Fetch Subjects
        async function fetchSubjects(semId) {
            const cacheKey = `Subjects_${semId}`;
            if (cache[cacheKey]) return cache[cacheKey];
            const { records } = await fetchFromAirtable('Subjects', `{Semester}="${semId}"`);
            const subjects = records.map(record => ({
                id: record.id,
                name: record.fields.Name || 'Unnamed Subject',
                credits: record.fields.Credits || 0
            }));
            cache[cacheKey] = subjects;
            return subjects;
        }

        // Fetch Notes
        async function fetchNotes(subjectId, offset = null) {
            const cacheKey = `Notes_${subjectId}`;
            if (!offset && cache[cacheKey]) return cache[cacheKey];
            const { records, offset: nextOffset } = await fetchFromAirtable('Notes', `{Subject}="${subjectId}"`, offset);
            const notes = records.map(record => ({
                id: record.id,
                name: record.fields.Name || 'Unnamed Note',
                date: record.fields.Date || 'Unknown Date',
                type: record.fields.Type || 'Unknown Type',
                fileUrl: record.fields.File && record.fields.File[0] ? record.fields.File[0].url : null,
                subjectId: subjectId
            }));
            if (nextOffset) {
                const moreNotes = await fetchNotes(subjectId, nextOffset);
                notes.push(...moreNotes);
            }
            if (!offset) cache[cacheKey] = notes;
            return notes;
        }

        // Fetch All Notes for Global Search
        async function fetchAllNotes() {
            const cacheKey = 'AllNotes';
            if (cache[cacheKey]) return cache[cacheKey];
            const { records, offset } = await fetchFromAirtable('Notes');
            let notes = records.map(record => ({
                id: record.id,
                name: record.fields.Name || 'Unnamed Note',
                date: record.fields.Date || 'Unknown Date',
                type: record.fields.Type || 'Unknown Type',
                fileUrl: record.fields.File && record.fields.File[0] ? record.fields.File[0].url : null,
                subjectId: record.fields.Subject ? record.fields.Subject[0] : null
            }));
            if (offset) {
                const moreNotes = await fetchFromAirtable('Notes', '', offset);
                notes = notes.concat(moreNotes.records.map(record => ({
                    id: record.id,
                    name: record.fields.Name || 'Unnamed Note',
                    date: record.fields.Date || 'Unknown Date',
                    type: record.fields.Type || 'Unknown Type',
                    fileUrl: record.fields.File && record.fields.File[0] ? record.fields.File[0].url : null,
                    subjectId: record.fields.Subject ? record.fields.Subject[0] : null
                })));
            }
            cache[cacheKey] = notes;
            return notes;
        }

        // Render Departments
        function renderDepartments() {
            departmentsGrid.innerHTML = Object.values(departmentsData).map(dept => `
                <div class="department-card" data-dept="${dept.id}">
                    <div class="department-icon" style="background-color: ${dept.color}">${dept.icon}</div>
                    <div class="department-info">
                        <h3 class="department-name">${dept.name}</h3>
                        <p class="department-desc">${dept.description}</p>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.department-card').forEach(card => {
                card.addEventListener('click', () => openDepartment(card.getAttribute('data-dept')));
            });
        }

        // Welcome Overlay Handler
        enterButton.addEventListener('click', () => {
            welcomeOverlay.style.opacity = '0';
            setTimeout(() => welcomeOverlay.style.display = 'none', 500);
        });

        // Close Modal Handler
        closeModal.addEventListener('click', () => {
            departmentModal.style.display = 'none';
            searchBar.value = '';
        });

        // Open Department
        async function openDepartment(deptId) {
            currentDept = deptId;
            currentSem = null;
            currentSubject = null;
            breadcrumbHistory = [departmentsData[deptId].name];
            modalTitle.textContent = departmentsData[deptId].name;

            const semesters = await fetchSemesters(deptId);
            let content = `
                <div class="breadcrumb">${breadcrumbHistory.map(item => `<div class="breadcrumb-item">${item}</div>`).join('')}</div>
                <div class="semester-list">
                    ${semesters.length ? semesters.map(sem => `
                        <div class="semester-item" data-sem="${sem.id}">${sem.name}</div>
                    `).join('') : '<p class="error-message">No semesters available.</p>'}
                </div>
            `;
            modalBody.innerHTML = content;

            modalBody.querySelectorAll('.semester-item').forEach(item => {
                item.addEventListener('click', () => openSemester(item.getAttribute('data-sem')));
            });
            departmentModal.style.display = 'flex';
        }

        // Open Semester
        async function openSemester(semId) {
            currentSem = semId;
            currentSubject = null;
            const semesters = await fetchSemesters(currentDept);
            const sem = semesters.find(s => s.id === semId);
            breadcrumbHistory = [departmentsData[currentDept].name, sem.name];

            const subjects = await fetchSubjects(semId);
            let content = `
                <div class="breadcrumb">
                    <div class="breadcrumb-item" onclick="openDepartment('${currentDept}')">${departmentsData[currentDept].name}</div>
                    <div class="breadcrumb-item">${sem.name}</div>
                </div>
                <button class="back-button" onclick="openDepartment('${currentDept}')">← Back</button>
                <div class="subject-list">
                    ${subjects.length ? subjects.map(subject => `
                        <div class="subject-item" data-subject="${subject.id}">
                            ${subject.name} (${subject.credits} Credits)
                        </div>
                    `).join('') : '<p>No subjects available.</p>'}
                </div>
            `;
            modalBody.innerHTML = content;

            modalBody.querySelectorAll('.subject-item').forEach(item => {
                item.addEventListener('click', () => openSubject(item.getAttribute('data-subject')));
            });
        }

        // Open Subject
        async function openSubject(subjectId) {
            currentSubject = subjectId;
            const semesters = await fetchSemesters(currentDept);
            const sem = semesters.find(s => s.id === currentSem);
            const subjects = await fetchSubjects(currentSem);
            const subject = subjects.find(s => s.id === subjectId);
            breadcrumbHistory = [departmentsData[currentDept].name, sem.name, subject.name];

            const notes = await fetchNotes(subjectId);
            let content = `
                <div class="breadcrumb">
                    <div class="breadcrumb-item" onclick="openDepartment('${currentDept}')">${departmentsData[currentDept].name}</div>
                    <div class="breadcrumb-item" onclick="openSemester('${currentSem}')">${sem.name}</div>
                    <div class="breadcrumb-item">${subject.name}</div>
                </div>
                <button class="back-button" onclick="openSemester('${currentSem}')">← Back</button>
                <div class="notes-list">
                    ${notes.length ? notes.map(note => `
                        <div class="notes-item">
                            <div>
                                <span class="notes-name">${note.name}</span>
                                <span class="notes-badge">${note.type}</span>
                                <div class="notes-date">Uploaded: ${note.date}</div>
                            </div>
                            ${note.fileUrl ? `<button class="download-button" onclick="window.open('${note.fileUrl}', '_blank')">Download</button>` : '<p class="error-message">No PDF</p>'}
                        </div>
                    `).join('') : '<p>No notes available.</p>'}
                </div>
            `;
            modalBody.innerHTML = content;
        }

        // Subject-Specific Search
        async function renderSubjectNotes(notes) {
            const semesters = await fetchSemesters(currentDept);
            const sem = semesters.find(s => s.id === currentSem);
            const subjects = await fetchSubjects(currentSem);
            const subject = subjects.find(s => s.id === currentSubject);
            let content = `
                <div class="breadcrumb">
                    <div class="breadcrumb-item" onclick="openDepartment('${currentDept}')">${departmentsData[currentDept].name}</div>
                    <div class="breadcrumb-item" onclick="openSemester('${currentSem}')">${sem.name}</div>
                    <div class="breadcrumb-item">${subject.name}</div>
                </div>
                <button class="back-button" onclick="openSemester('${currentSem}')">← Back</button>
                <div class="notes-list">
                    ${notes.length ? notes.map(note => `
                        <div class="notes-item">
                            <div>
                                <span class="notes-name">${note.name}</span>
                                <span class="notes-badge">${note.type}</span>
                                <div class="notes-date">Uploaded: ${note.date}</div>
                            </div>
                            ${note.fileUrl ? `<button class="download-button" onclick="window.open('${note.fileUrl}', '_blank')">Download</button>` : '<p class="error-message">No PDF</p>'}
                        </div>
                    `).join('') : '<p>No notes match your search.</p>'}
                </div>
            `;
            modalBody.innerHTML = content;
        }

        // Global Search
        async function renderGlobalSearch(notes) {
            modalTitle.textContent = 'Search Results';
            let content = `
                <div class="breadcrumb"><div class="breadcrumb-item">All Notes</div></div>
                <button class="back-button" onclick="renderDepartments(); departmentModal.style.display = 'none';">← Back to Departments</button>
                <div class="notes-list">
                    ${notes.length ? notes.map(note => `
                        <div class="notes-item">
                            <div>
                                <span class="notes-name">${note.name}</span>
                                <span class="notes-badge">${note.type}</span>
                                <div class="notes-date">Uploaded: ${note.date}</div>
                            </div>
                            ${note.fileUrl ? `<button class="download-button" onclick="window.open('${note.fileUrl}', '_blank')">Download</button>` : '<p class="error-message">No PDF</p>'}
                        </div>
                    `).join('') : '<p>No notes match your search.</p>'}
                </div>
            `;
            modalBody.innerHTML = content;
            departmentModal.style.display = 'flex';
        }

        // Search Functionality (Combined Subject-Specific and Global)
        searchBar.addEventListener('input', async (e) => {
            const query = e.target.value.toLowerCase();
            if (!query) {
                if (currentSubject) openSubject(currentSubject);
                else if (currentSem) openSemester(currentSem);
                else if (currentDept) openDepartment(currentDept);
                return;
            }

            if (currentSubject) {
                // Subject-specific search
                const notes = await fetchNotes(currentSubject);
                const filteredNotes = notes.filter(note => 
                    note.name.toLowerCase().includes(query) || note.type.toLowerCase().includes(query)
                );
                renderSubjectNotes(filteredNotes);
            } else {
                // Global search
                const allNotes = await fetchAllNotes();
                const filteredNotes = allNotes.filter(note => 
                    note.name.toLowerCase().includes(query) || note.type.toLowerCase().includes(query)
                );
                renderGlobalSearch(filteredNotes);
            }
        });

        // Close Modal on Outside Click
        window.addEventListener('click', (e) => {
            if (e.target === departmentModal) {
                departmentModal.style.display = 'none';
                searchBar.value = '';
            }
        });

        // Make Functions Global
        window.openDepartment = openDepartment;
        window.openSemester = openSemester;
        window.openSubject = openSubject;

        // Initial Load
        document.addEventListener('DOMContentLoaded', fetchDepartments);
    </script>
</body>
</html>